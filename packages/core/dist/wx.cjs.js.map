{"version":3,"file":"wx.cjs.js","sources":["../src/wx.ts"],"sourcesContent":["import merge from 'lodash-es/merge'\nimport type { RequiredProperty, ResponseResult } from './shared'\n\nexport * from './shared'\n\ntype BaseResponse = string | object | ArrayBuffer\n\ninterface WechatResponse<T extends BaseResponse = BaseResponse> extends WechatMiniprogram.RequestSuccessCallbackResult {\n  data: T\n}\n/**\n * 拦截器\n */\nexport interface WechatRequestInterceptors<T extends object> {\n  request?: (value: WechatRequestConfig<T>) => WechatRequestConfig<T> | Promise<WechatRequestConfig<T>>\n  requestError?: (error: any) => (Promise<any> | any)\n  response?: ((value: { config: WechatRequestConfig<T>, response: WechatResponse }) => WechatResponse | Promise< WechatResponse>)\n  responseError?: (error: any) => (Promise<any> | any)\n}\n/**\n * RequestBaseConfig 请求配置\n */\nexport interface WechatRequestBaseConfig extends Partial<Omit<WechatMiniprogram.RequestOption, 'success' | 'fail' | 'complete'>> {\n  /**\n   * 公共url\n   */\n  baseUrl?: string\n  /**\n   * get 请求参数\n   */\n  params?: any\n  /**\n   * 返回原生响应 AppResponse<T> 默认false\n   */\n  getResponse?: boolean\n  /**\n   * 忽略 loading 提示\n   */\n  ignoreLoading?: boolean\n}\n\n/**\n *  返回原生响应 AppResponse<T>\n */\ninterface WechatRequestGetResponseConfig {\n  getResponse: true\n};\n\n/**\n * 用户自定义请求配置\n */\nexport type WechatRequestConfig<T extends object> = WechatRequestBaseConfig & T\n\n/**\n * 用户自定义请求配置\n */\ntype WechatRequestConfigWithoutMethod<T extends object> =\nRequiredProperty<Omit<WechatRequestBaseConfig, 'method' | 'baseUrl'>, 'url'> & T\n\n/**\n * 用户自定义 get 请求配置 get 请求参设置请使用 params 而不是 data\n */\ntype WechatRequestGetConfigWithoutMethod<T extends object> = RequiredProperty<Omit<WechatRequestBaseConfig, 'method' | 'baseUrl' | 'data'>, 'url'> & T\n/**\n * 实现\n */\nexport class WxRequest<T extends object> {\n  /**\n   * 基础配置\n   */\n  private baseConfig: WechatRequestConfig<T>\n  /**\n   * 拦截器\n   */\n  private interceptors?: WechatRequestInterceptors<T>\n  /**\n   * @param options 基础配置\n   * @param interceptors 拦截器\n   */\n  constructor(options: WechatRequestConfig<T>, interceptors?: WechatRequestInterceptors<T>) {\n    this.baseConfig = {\n      ...options,\n    }\n    this.interceptors = interceptors\n  }\n\n  get<D extends object>(config: WechatRequestGetConfigWithoutMethod<T> & WechatRequestGetResponseConfig): Promise< WechatResponse<ResponseResult<D>>>\n  get<D extends object>(config: WechatRequestGetConfigWithoutMethod<T>): Promise<ResponseResult<D>>\n  get<D extends object>(config: WechatRequestGetConfigWithoutMethod<T>): Promise< WechatResponse<D> | ResponseResult<D>> {\n    return this.request({ ...config, method: 'GET' })\n  }\n\n  post<D extends object>(config: WechatRequestConfigWithoutMethod<T> & WechatRequestGetResponseConfig): Promise< WechatResponse<ResponseResult<D>>>\n  post<D extends object>(config: WechatRequestConfigWithoutMethod<T>): Promise<ResponseResult<D>>\n  post<D extends object>(config: WechatRequestConfigWithoutMethod<T>): Promise< WechatResponse<D> | ResponseResult<D>> {\n    return this.request({ ...config, method: 'POST' })\n  }\n\n  put<D extends object>(config: WechatRequestConfigWithoutMethod<T> & WechatRequestGetResponseConfig): Promise< WechatResponse<ResponseResult<D>>>\n  put<D extends object>(config: WechatRequestConfigWithoutMethod<T>): Promise<ResponseResult<D>>\n  put<D extends object>(config: WechatRequestConfigWithoutMethod<T>): Promise< WechatResponse<D> | ResponseResult<D>> {\n    return this.request({ ...config, method: 'PUT' })\n  }\n\n  delete<D extends object>(config: WechatRequestConfigWithoutMethod<T> & WechatRequestGetResponseConfig): Promise< WechatResponse<ResponseResult<D>>>\n  delete<D extends object>(config: WechatRequestConfigWithoutMethod<T>): Promise<ResponseResult<D>>\n  delete<D extends object>(config: WechatRequestConfigWithoutMethod<T>): Promise< WechatResponse<D> | ResponseResult<D>> {\n    return this.request({ ...config, method: 'DELETE' })\n  }\n\n  async request<D extends object>(config: WechatRequestConfig<T> & WechatRequestGetResponseConfig): Promise< WechatResponse<ResponseResult<D>>>\n  async request<D extends object>(config: WechatRequestConfig<T>): Promise<ResponseResult<D>>\n  async request<D extends object>(config: WechatRequestConfig<T>): Promise< WechatResponse<D> | ResponseResult<D>> {\n    let _config = merge({}, this.baseConfig, config)\n    try {\n      _config = await this.interceptors?.request?.(_config) || _config\n    }\n    catch (error) {\n      this.interceptors?.requestError?.(error)\n      throw error\n    }\n\n    return new Promise((resolve, reject) => {\n      wx.request({\n        ..._config as WechatMiniprogram.RequestOption,\n        success: async (response) => {\n          const userResponse = await this.interceptors?.response?.({ config: _config, response }) as WechatResponse<D>\n          resolve(userResponse || response)\n        },\n        fail: (error) => {\n          this.interceptors?.responseError?.(error)\n          reject(error)\n        },\n      })\n    })\n  }\n}\n"],"names":["merge"],"mappings":";;;;AA+DA;;AAEG;MACU,SAAS,CAAA;AACpB;;AAEG;AACK,IAAA,UAAU,CAAwB;AAC1C;;AAEG;AACK,IAAA,YAAY,CAA+B;AACnD;;;AAGG;IACH,WAAY,CAAA,OAA+B,EAAE,YAA2C,EAAA;QACtF,IAAI,CAAC,UAAU,GAAG;AAChB,YAAA,GAAG,OAAO;SACX,CAAA;AACD,QAAA,IAAI,CAAC,YAAY,GAAG,YAAY,CAAA;KACjC;AAID,IAAA,GAAG,CAAmB,MAA8C,EAAA;AAClE,QAAA,OAAO,IAAI,CAAC,OAAO,CAAC,EAAE,GAAG,MAAM,EAAE,MAAM,EAAE,KAAK,EAAE,CAAC,CAAA;KAClD;AAID,IAAA,IAAI,CAAmB,MAA2C,EAAA;AAChE,QAAA,OAAO,IAAI,CAAC,OAAO,CAAC,EAAE,GAAG,MAAM,EAAE,MAAM,EAAE,MAAM,EAAE,CAAC,CAAA;KACnD;AAID,IAAA,GAAG,CAAmB,MAA2C,EAAA;AAC/D,QAAA,OAAO,IAAI,CAAC,OAAO,CAAC,EAAE,GAAG,MAAM,EAAE,MAAM,EAAE,KAAK,EAAE,CAAC,CAAA;KAClD;AAID,IAAA,MAAM,CAAmB,MAA2C,EAAA;AAClE,QAAA,OAAO,IAAI,CAAC,OAAO,CAAC,EAAE,GAAG,MAAM,EAAE,MAAM,EAAE,QAAQ,EAAE,CAAC,CAAA;KACrD;IAID,MAAM,OAAO,CAAmB,MAA8B,EAAA;AAC5D,QAAA,IAAI,OAAO,GAAGA,WAAK,CAAC,EAAE,EAAE,IAAI,CAAC,UAAU,EAAE,MAAM,CAAC,CAAA;AAChD,QAAA,IAAI;AACF,YAAA,OAAO,GAAG,MAAM,IAAI,CAAC,YAAY,EAAE,OAAO,GAAG,OAAO,CAAC,IAAI,OAAO,CAAA;SACjE;QACD,OAAO,KAAK,EAAE;YACZ,IAAI,CAAC,YAAY,EAAE,YAAY,GAAG,KAAK,CAAC,CAAA;AACxC,YAAA,MAAM,KAAK,CAAA;SACZ;QAED,OAAO,IAAI,OAAO,CAAC,CAAC,OAAO,EAAE,MAAM,KAAI;YACrC,EAAE,CAAC,OAAO,CAAC;AACT,gBAAA,GAAG,OAA0C;AAC7C,gBAAA,OAAO,EAAE,OAAO,QAAQ,KAAI;AAC1B,oBAAA,MAAM,YAAY,GAAG,MAAM,IAAI,CAAC,YAAY,EAAE,QAAQ,GAAG,EAAE,MAAM,EAAE,OAAO,EAAE,QAAQ,EAAE,CAAsB,CAAA;AAC5G,oBAAA,OAAO,CAAC,YAAY,IAAI,QAAQ,CAAC,CAAA;iBAClC;AACD,gBAAA,IAAI,EAAE,CAAC,KAAK,KAAI;oBACd,IAAI,CAAC,YAAY,EAAE,aAAa,GAAG,KAAK,CAAC,CAAA;oBACzC,MAAM,CAAC,KAAK,CAAC,CAAA;iBACd;AACF,aAAA,CAAC,CAAA;AACJ,SAAC,CAAC,CAAA;KACH;AACF;;;;;;;;;;;;"}