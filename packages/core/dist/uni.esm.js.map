{"version":3,"file":"uni.esm.js","sources":["../src/uni.ts"],"sourcesContent":["import merge from 'lodash-es/merge'\n\nimport type { RequiredProperty, ResponseResult } from './shared'\n\nexport * from './shared'\n\ntype BaseResponse = string | object | ArrayBuffer\n\ninterface UniAppResponse<T extends BaseResponse = BaseResponse> extends UniApp.RequestSuccessCallbackResult {\n  data: T\n}\n\n/**\n * UniRequestBaseConfig 请求配置\n */\nexport interface UniRequestBaseConfig extends Partial<UniNamespace.RequestOptions> {\n  /**\n   * 公共url\n   */\n  baseUrl?: string\n  /**\n   * get 请求参数\n   */\n  params?: any\n  /**\n   * 返回原生响应 UniAppResponse<T> 默认false\n   */\n  getResponse?: boolean\n  /**\n   * 忽略 loading 提示\n   */\n  ignoreLoading?: boolean\n}\n\n/**\n *  返回原生响应\n */\ninterface UniRequestGetResponseConfig {\n  getResponse: true\n};\n\n/**\n * 用户自定义请求配置\n */\nexport type UniRequestConfig<T extends object> = UniRequestBaseConfig & T\n\n/**\n * 用户自定义请求配置\n */\ntype UniRequestConfigWithoutMethod<T extends object> =\nRequiredProperty<Omit<UniRequestBaseConfig, 'method' | 'baseUrl'>, 'url'> & T\n\n/**\n * 用户自定义 get 请求配置 get 请求参设置请使用 params 而不是 data\n */\ntype UniRequestGetConfigWithoutMethod<T extends object> = RequiredProperty<Omit<UniRequestBaseConfig, 'method' | 'baseUrl' | 'data'>, 'url'> & T\n\n/**\n * 拦截器\n */\nexport interface UniRequestInterceptors<T extends object> {\n  request?: (value: UniRequestConfig<T>) => UniRequestConfig<T> | Promise<UniRequestConfig<T>>\n  requestError?: (error: any) => (Promise<any> | any)\n  response?: ((value: { config: UniRequestConfig<T>, response: UniAppResponse }) => UniAppResponse | Promise<UniAppResponse>)\n  responseError?: (error: any) => (Promise<any> | any)\n}\n/**\n * 实现\n */\nexport class UniRequest<T extends object> {\n  /**\n   * 基础配置\n   */\n  private baseConfig: UniRequestConfig<T>\n  /**\n   * 拦截器\n   */\n  private interceptors?: UniRequestInterceptors<T>\n  /**\n   * @param options 基础配置\n   * @param interceptors 拦截器\n   */\n  constructor(options: UniRequestConfig<T>, interceptors?: UniRequestInterceptors<T>) {\n    this.baseConfig = {\n      ...options,\n    }\n    this.interceptors = interceptors\n  }\n\n  get<D extends object>(config: UniRequestGetConfigWithoutMethod<T> & UniRequestGetResponseConfig): Promise<UniAppResponse<ResponseResult<D>>>\n  get<D extends object>(config: UniRequestGetConfigWithoutMethod<T>): Promise<ResponseResult<D>>\n  get<D extends object>(config: UniRequestGetConfigWithoutMethod<T>): Promise<UniAppResponse<D> | ResponseResult<D>> {\n    return this.request({ ...config, method: 'GET' })\n  }\n\n  post<D extends object>(config: UniRequestConfigWithoutMethod<T> & UniRequestGetResponseConfig): Promise<UniAppResponse<ResponseResult<D>>>\n  post<D extends object>(config: UniRequestConfigWithoutMethod<T>): Promise<ResponseResult<D>>\n  post<D extends object>(config: UniRequestConfigWithoutMethod<T>): Promise<UniAppResponse<D> | ResponseResult<D>> {\n    return this.request({ ...config, method: 'POST' })\n  }\n\n  put<D extends object>(config: UniRequestConfigWithoutMethod<T> & UniRequestGetResponseConfig): Promise<UniAppResponse<ResponseResult<D>>>\n  put<D extends object>(config: UniRequestConfigWithoutMethod<T>): Promise<ResponseResult<D>>\n  put<D extends object>(config: UniRequestConfigWithoutMethod<T>): Promise<UniAppResponse<D> | ResponseResult<D>> {\n    return this.request({ ...config, method: 'PUT' })\n  }\n\n  delete<D extends object>(config: UniRequestConfigWithoutMethod<T> & UniRequestGetResponseConfig): Promise<UniAppResponse<ResponseResult<D>>>\n  delete<D extends object>(config: UniRequestConfigWithoutMethod<T>): Promise<ResponseResult<D>>\n  delete<D extends object>(config: UniRequestConfigWithoutMethod<T>): Promise<UniAppResponse<D> | ResponseResult<D>> {\n    return this.request({ ...config, method: 'DELETE' })\n  }\n\n  async request<D extends object>(config: UniRequestConfig<T> & UniRequestGetResponseConfig): Promise<UniAppResponse<ResponseResult<D>>>\n  async request<D extends object>(config: UniRequestConfig<T>): Promise<ResponseResult<D>>\n  async request<D extends object>(config: UniRequestConfig<T>): Promise<UniAppResponse<D> | ResponseResult<D>> {\n    let _config = merge({}, this.baseConfig, config)\n    try {\n      _config = await this.interceptors?.request?.(_config) || _config\n    }\n    catch (error) {\n      console.log('interceptors?.requestError ', error)\n      this.interceptors?.requestError?.(error)\n      throw error\n    }\n    try {\n      /**\n       * 没有 loading 的请求 在开发环境会报错, 你可以设置 ignoreLoading 取消警告\n       */\n      const response = await uni.request(_config as UniNamespace.RequestOptions) as UniAppResponse<D>\n      const userResponse = await this.interceptors?.response?.({ config: _config, response }) as UniAppResponse<D>\n      return userResponse || response\n    }\n    catch (error) {\n      this.interceptors?.responseError?.(error)\n      throw error\n    }\n  }\n}\n"],"names":[],"mappings":";;;AAkEA;;AAEG;MACU,UAAU,CAAA;AACrB;;AAEG;AACK,IAAA,UAAU,CAAqB;AACvC;;AAEG;AACK,IAAA,YAAY,CAA4B;AAChD;;;AAGG;IACH,WAAY,CAAA,OAA4B,EAAE,YAAwC,EAAA;QAChF,IAAI,CAAC,UAAU,GAAG;AAChB,YAAA,GAAG,OAAO;SACX,CAAA;AACD,QAAA,IAAI,CAAC,YAAY,GAAG,YAAY,CAAA;KACjC;AAID,IAAA,GAAG,CAAmB,MAA2C,EAAA;AAC/D,QAAA,OAAO,IAAI,CAAC,OAAO,CAAC,EAAE,GAAG,MAAM,EAAE,MAAM,EAAE,KAAK,EAAE,CAAC,CAAA;KAClD;AAID,IAAA,IAAI,CAAmB,MAAwC,EAAA;AAC7D,QAAA,OAAO,IAAI,CAAC,OAAO,CAAC,EAAE,GAAG,MAAM,EAAE,MAAM,EAAE,MAAM,EAAE,CAAC,CAAA;KACnD;AAID,IAAA,GAAG,CAAmB,MAAwC,EAAA;AAC5D,QAAA,OAAO,IAAI,CAAC,OAAO,CAAC,EAAE,GAAG,MAAM,EAAE,MAAM,EAAE,KAAK,EAAE,CAAC,CAAA;KAClD;AAID,IAAA,MAAM,CAAmB,MAAwC,EAAA;AAC/D,QAAA,OAAO,IAAI,CAAC,OAAO,CAAC,EAAE,GAAG,MAAM,EAAE,MAAM,EAAE,QAAQ,EAAE,CAAC,CAAA;KACrD;IAID,MAAM,OAAO,CAAmB,MAA2B,EAAA;AACzD,QAAA,IAAI,OAAO,GAAG,KAAK,CAAC,EAAE,EAAE,IAAI,CAAC,UAAU,EAAE,MAAM,CAAC,CAAA;AAChD,QAAA,IAAI;AACF,YAAA,OAAO,GAAG,MAAM,IAAI,CAAC,YAAY,EAAE,OAAO,GAAG,OAAO,CAAC,IAAI,OAAO,CAAA;SACjE;QACD,OAAO,KAAK,EAAE;AACZ,YAAA,OAAO,CAAC,GAAG,CAAC,6BAA6B,EAAE,KAAK,CAAC,CAAA;YACjD,IAAI,CAAC,YAAY,EAAE,YAAY,GAAG,KAAK,CAAC,CAAA;AACxC,YAAA,MAAM,KAAK,CAAA;SACZ;AACD,QAAA,IAAI;AACF;;AAEG;YACH,MAAM,QAAQ,GAAG,MAAM,GAAG,CAAC,OAAO,CAAC,OAAsC,CAAsB,CAAA;AAC/F,YAAA,MAAM,YAAY,GAAG,MAAM,IAAI,CAAC,YAAY,EAAE,QAAQ,GAAG,EAAE,MAAM,EAAE,OAAO,EAAE,QAAQ,EAAE,CAAsB,CAAA;YAC5G,OAAO,YAAY,IAAI,QAAQ,CAAA;SAChC;QACD,OAAO,KAAK,EAAE;YACZ,IAAI,CAAC,YAAY,EAAE,aAAa,GAAG,KAAK,CAAC,CAAA;AACzC,YAAA,MAAM,KAAK,CAAA;SACZ;KACF;AACF;;;;"}